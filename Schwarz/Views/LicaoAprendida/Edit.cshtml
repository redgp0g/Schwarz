@model LicaoAprendida
@{
	ViewData["Title"] = "Editar";
	Layout = "_Layout";
}

<div class="container mx-auto">
	<div class="flex justify-center px-6 my-12">
		<div class="w-full lg:w-7/12 bg-white p-2 rounded-lg">
			<h3 class="pt-4 text-2xl text-center">Formulário de Edição</h3>
			<form id="form" method="post" class="px-8">
				<div class="mb-4">
					<label asp-for="Motivo" class="block mb-2 text-sm font-bold text-gray-700l flex items-center"></label>
					<textarea asp-for="Motivo" style="min-height: calc(1.5em + 0.75rem + 100px);" class="w-full px-3 py-2 mb-3 text-sm leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline w-full px-3 py-2 mb-3 text-sm leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" autocomplete="off" placeholder="Descreva sobre sua ideia" required></textarea>
					@Html.ValidationMessageFor(x => x.Motivo)
				</div>
				
					<div class="mb-4">
						<label asp-for="Planejado" class="block mb-2 text-sm font-bold text-gray-700l"></label>
						<input asp-for="Planejado" class="w-full px-3 py-2 text-sm leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" autocomplete="off" placeholder="Descreva o ganho" />
						@Html.ValidationMessageFor(x => x.Planejado
						)
					</div>
					<div class="mb-4">
						<label asp-for="Realizado" class="block mb-2 text-sm font-bold text-gray-700l"></label>
						<input asp-for="Realizado" class="w-full px-3 py-2 text-sm leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" autocomplete="off" placeholder="Ganho realizado" />
						@Html.ValidationMessageFor(x => x.Realizado)
					</div>
				
				<div class="my-3">
					<input type="file" id="novoanexo" multiple>
					<label class="p-2 text-white bg-gradient-to-r from-green-500 to-emerald-700 rounded-lg hover:bg-gradient-to-r hover:from-emerald-500 hover:to-green-800 hover:cursor-pointer focus:outline-none focus:shadow-outline adicionar-anexo">
						Adicionar
					</label>
				</div>

				<div class="my-6">
					<input type="hidden" asp-for="IDLicaoAprendida" />
					<input type="submit" value="Editar" class="text-xl w-full px-2 py-2 font-bold text-white bg-gradient-to-r from-orange-300 to-yellow-500 rounded-full hover:bg-gradient-to-r hover:from-amber-300 hover:to-yellow-500 rounded-full hover:cursor-pointer focus:outline-none focus:shadow-outline" />
				</div>
			</form>
		</div>
	</div>
</div>

<script>
	$(document).ready(function () {
		$('.select2').select2();
	});

	$(document).on('click', '.adicionar-participante', function () {	
		var idideia = $('#idideia').val();
		var idFuncionario = $('#novoparticipante').val();


		$.ajax({
			url: '/Ideia/AdicionarParticipante',
			type: 'POST',
			data: { idFuncionario: idFuncionario, idideia: idideia },
			success: function (response) {
				var nome = response.nome;
				var idEquipeideia = response.idEquipe;

				var divParticipanteExistente = $('.participante:first');
				var divParticipanteClonada = divParticipanteExistente.clone();
				divParticipanteClonada.find('label').text(nome);
				divParticipanteClonada.find('button').attr('data-id', idEquipeideia);

				$('.listaparticipantes').append(divParticipanteClonada);
				qtdpartc++;
			},
			error: function (xhr, status, error) {
				if (xhr.status == 409) {
					alert('Este participante já está na equipe.');
				} else {
					alert('Ocorreu um erro ao adicionar o participante.');
				}
			}
		});
	});
	$(document).on('click', '.remover-participante', function () {
		if (qtdpartc > 1) {
			var divParticipante = $(this).parent();
			var id = $(this).data('id');
			var confirmar = confirm("Tem certeza que deseja excluir este participante?");

			if (confirmar) {
				$.ajax({
					url: '/Ideia/DeletarParticipante',
					type: 'POST',
					data: { id: id },
					success: function () {
						divParticipante.remove();
						qtdpartc--;
					},
					error: function () {
						alert('Ocorreu um erro ao remover o participante.');
					}
				});
			}
		}
		else{
			alert('Não é possível excluir todos os participantes!');
		}
	});

	$(document).on('click', '.adicionar-anexo', function () {
		var files = $('#novoanexo')[0].files;
		var idideia = $('#idideia').val();

		if(files.length === 0){
			alert("Selecione pelo menos um arquivo para adicionar!");
			return;
		}

		var formData = new FormData();
		for (var i = 0; i < files.length; i++) {
			formData.append('files', files[i]);
		}
		formData.append('idideia', idideia); // Adicionar o parâmetro idideia ao FormData

		$.ajax({
			url: '/Ideia/AdicionarAnexo',
			type: 'POST',
			data: formData,
			processData: false,
			contentType: false,
			success: function (response) {
				// Processar a resposta do servidor, se necessário
				location.reload(); // Recarregar a página após adicionar os anexos com sucesso
			},
			fail: function (jqXHR, textStatus, errorThrown) {
				alert('Ocorreu um erro ao adicionar o anexo: ' + errorThrown);
			}
		});
	});

	$(document).on('click', '.remover-anexo', function () {
		var id = $(this).data('id');
		var confirmar = confirm("Tem certeza que deseja excluir este anexo?");

		if (confirmar) {
			$.ajax({
				url: '/Ideia/RemoverAnexo',
				type: 'POST',
				data: { id: id },
				success: function () {
					location.reload();
				},
				error: function () {
					alert('Ocorreu um erro ao remover o anexo.');
				}
			});
		}
	});

</script>